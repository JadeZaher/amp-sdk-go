syntax = "proto3";

// package amp is an implementation-independent API for a pluggable client-server UI/UX system,
// featuring support and integration for files, media, and communication.
package amp;

// Tells protoc that a .proto file importing amp.proto what package import to use within Go.
option go_package = "github.com/amp-3d/amp-sdk-go/amp";

// import "github.com/gogo/protobuf/gogoproto/gogo.proto";  // https://stackoverflow.com/questions/43026449/gogo-proto-file-not-found

option csharp_namespace = "AMP";


enum Const {
    Const_Defs = 0;

    // TIDBinaryLen is the byte size of a Tx ID ("TID"), a hash with a leading big endian binary time index.
    //
    // This allows TIDs to be sorted chronologically, improving catalog (search) efficiency. 
    // This facilitates Tx storage and Tx syndication (time-ordered Tx playback).  
    // Importantly, a TxID (32 bytes) is has a UTC16 prefix, allowing efficient LSM storage to scale to billions of Txs.
    //
    // Byte layout is designed so that TIDs are sortable by their embedded timestamp:
    //    0:6   - Standard UTC timestamp in unix seconds (big endian)
    //    6:8   - Timestamp fraction (big endian)
    //    8:32  - Signature/hash suffix.
    Const_TIDBinaryLen = 32;

    // TIDStringLen is the ASCII-compatible string length of a (binary) TID encoded into its base32 form.
    // The encoding used is the geo-hash base32 alphabet, so that even ascii ordinal string comparisons will correctly sort encoded TIDs by time.
    Const_TIDStringLen = 52;

    // DefaultServicePort  is the default TCP port used to expose amp.Host service.
    Const_DefaultServicePort = 5192;
    
	// Byte size and version of a TxMsg encoding -- sizes are little endian
	// A TxHeader has the following layout:
    //   Bytes  00:03 -- TxHeader marker ('amp') 
	//          03:04 -- Const_TxHeader_Version
    //          04:08 -- TxMsg body size: header + serialized TxOp(s)
    //          08:12 -- TxMsg.DataStore size
    //          12:16 -- Reserved 
	Const_TxHeader_Size = 16;
	
	// Version of the TxHeader -- first byte
    Const_TxHeader_Version = 0x33;
	
	// The first byte of the TxHeader is the header size and version and
	// the following 3 bytes of a serialized TxMsg ("amp") 
    Const_TxHeader_Marker = 0x616D70; 
}



// TxOpCode specifies a particular cell transaction operation.
enum TxOpCode {
    TxOpCode_Nil        = 0x00;
    TxOpCode_MetaAttr   = 0x01; // Used for session-level meta events (e.g. login, etc)
    TxOpCode_UpsertAttr = 0x02; // If the first CellTx, this is the pinned cell, otherwise it is a child cell
    TxOpCode_RemoveAttr = 0x04; // remove attr element
    TxOpCode_RemoveCell = 0x10; 
}


// TxBody contains a max number of uint64 fields usable for any purpose.
enum TxField {
    TxField_0   = 0;
    TxField_MaxFields = 24;
    
    TxField_TargetIDx0 = 1;
    TxField_TargetIDx1 = 2;
    TxField_TargetIDx2 = 3;
    
    TxField_AttrID_0 = 4;
    TxField_AttrID_1 = 5;
    TxField_AttrID_2 = 6;
    
    TxField_SI_0 = 10;
    TxField_SI_1 = 11;
    TxField_SI_2 = 12;
    
    TxField_Hash = 13;
}


// TxInfo contains information for a TxMsg
message TxInfo {

    // communicates request status / completion.
    ReqStatus           Status = 2;
    
    // The number of TxOps in this TxMsg.
    uint64              NumOps = 4;
    
    // A globally unique Tag at when this Tx was created.
    int64               GenesisID_0 = 7;
    fixed64             GenesisID_1 = 8;
    fixed64             GenesisID_2 = 9;
    
    // Identifies an originating / requesting / associated client or listener.
    int64               ContextID_0 = 10;
    fixed64             ContextID_1 = 11;
    fixed64             ContextID_2 = 12;
    
}


enum SelectOp {
    SelectOp_Neutral = 0;
    SelectOp_Include = 1;
    SelectOp_Exclude = 2;
}

// ReqStatus allows a sender to express the status of a request.
enum ReqStatus {

    // The request is in the process of being formed
    ReqStatus_NotStarted   = 0;
    
    // Denotes that the request is in progress.
    ReqStatus_Syncing      = 1;
    
    // Sent by the host to signal that this ReqID up to date and the client state is stable / synchronized.
    // This generally drives UI updates or other aggregate cell dependencies.
    ReqStatus_Synced       = 2;
    
    // From the client to host, this signals to close / cancel the op associated with ReqID.
    // From the host to client, this signals that the given request ID has been closed / discarded.
    ReqStatus_Closed       = 3;
}

// Login -- STEP 1: client -> host
message Login {

    // A byte string identifying user who is logging in (lot limited to UTF8)
    // This is typically a username or a persistent Tag issued by the device OS when the app is (re)installed. 
    string              UserUID     = 1;
    
    // HostAddr is network address of the server known to the client (e.g. IP address, localhost, domain name, etc)
    // archost uses this to as the host name when serving URLs for the client to consume.
    string              HostAddr    = 2;
    
    string              DeviceLabel = 8;
    string              DeviceUID   = 9; 
    
    // Current or previous checkpoint -- optional
    AuthCheckpoint      Checkpoint  = 10;
}

// LoginChallenge -- STEP 2: host -> client
message LoginChallenge {
    bytes               Hash            = 1;
}

// LoginResponse -- STEP 3: client -> host
message LoginResponse {
    bytes               HashResponse    = 1;
}

// AuthCheckpoint  -- STEP 4: host -> client
message AuthCheckpoint {
    string              Token = 1;

    TagAttr             SessionTag = 10;
    TagAttr             MemberTag  = 11;

    // List of available channel types that a host emits at runtime so a client knows what kind of channel types are available.  
    TagAttr             HomeFeed = 9;

}

message HelloWorld {

}


/*
message TagSpec {

    // Composite tag expression syntax
    //       TagSpec := "[{utf8_tag}[.:/\]*]*{utf8_ElemTypeDesc} ""
    //
    // Note how a tag spec with no delimeters is a pure element type descriptor (and AttrSpecID == ElemSpecID)
    string              AsCanonic = 1;
    
    // Tag of AsCanonicString.
    int64               TagSpecIDx0 = 3;
    fixed64             TagSpecIDx1 = 4;
    fixed64             TagSpecIDx2 = 5;
    
    
    // Tag of "{ElemTypeDesc}"
    int64               ElemSpecIDx0 = 6;
    fixed64             ElemSpecIDx1 = 7;
    fixed64             ElemSpecIDx2 = 8;

}
*/
enum PinFlags {
    PinFlags_None             = 0;

	// If set, Pin.ServeState() causes this request (PinContext) to automatically close once state is pushed and synchronized.
	// Otherwise, the request remains open and the client will receive any state updates until closed.
    // This is useful when only a snapshot of the cell is needed.
    PinFlags_CloseOnSync      = 0x04;
    
    // If set, a pinned cell will not send any state updates to the client.
    // This is useful when only writing to a cell and no state updates are needed.
    PinFlags_NoSync           = 0x08;
    
}

// HandleURL is used as a meta attribute handle a URL, such as an oauth request (host to client) or an oauth response (client to host).
// TODO: make just a uniquely named Link
message HandleURL {
    string              URL = 1;
}

// Requests the creation of a new feed template (attr streams) to be pinned (or half-duplex channel) on the given cell / tag, returning CellInfo allowing new channels to be added to it.
// By convention, every cell carries a "amp.feed.genesis.TagEpoch" feed which in turn is a tag.Time series of []TagEpoch.
//    series expressing state for the cell's permissions and the channel catalog.
message FeedGenesis {
    TagAttr             MintToTarget = 1;
    
    // Attribute specs to subscribe to.
    repeated TagFeed    MintInstance = 2;
}


// PinRequest is a client request to "pin" a cell, meaning selected attrs and child cells will be pushed to the client.  
message PinRequest {

    TagAttr             PinURL = 1;
    
    // The {cell tag.ID}{attr tag.ID} to sync / pin / send.
    repeated TagAttr    SyncAttrs  = 7;
    
    // Bit options for this request.
    PinFlags            Flags = 10;

    // Delimited list of "semi-ordered" tags to filter the pinned cell.
    // ((:/\.\|)*{(-_\|\w)+})+
    string              TagQueryExpr = 16;
    
}


// CordType describes how to interpret coordinates contained in a Position.
enum CordType {
    CordType_Unspecified     = 0;
    CordType_Ordered         = 1;  // U is order ranking
    CordType_Plane_Cartesian = 5;  // (U,V,W) are cartesian coordinates
    CordType_Plane_HexEvenR  = 6;  // (U,V) are hexagonal "even-r" coordinates
    CordType_Geoid_Sphere    = 10; // U is lat, V is long, W is altitude (m)
    CordType_Geoid_WGS84     = 11; // U is lat, V is long, W is altitude (m)
}

// message GridPos {    
//     int64               U           = 3; 
//     int64               V           = 4;
//     int64               W           = 5;
// }
// message GeoPos {
// }

// Position describes a position in space and/or time using a given coordinate system.
message Position {
    CordType            CordType    = 1; // CordType describing how to interpret U,V,W
    
    double              U           = 3; 
    double              V           = 4;
    double              W           = 5;
    
    float               ROU         = 6; // radius of uncertainty (meters)
}


enum Enable {
    Enable_LatentOff  = 0x0;
    Enable_LatentOn   = 0x1;
    Enable_ActiveOn   = 0x2;
    Enable_ActiveOff  = 0x3;
}


enum UrlScheme {
    UrlScheme_Nil             = 0;  
    UrlScheme_Data            = 1;  // "[data:]{mime-type}[[;base64],{data-encoding}]"
    UrlScheme_Amp             = 2;  // "[amp:[//hostname/]]{cmd}[/{uri}]?{query}"
    UrlScheme_File            = 3;  // "[file://]{hfs-pathname}"
    UrlScheme_Http            = 4;  // "[http[s]://]{hostname}[:{port}]/{query}"
    
}


enum Metric {
    Metric_Nil                           = 0;
    Metric_OrthoPixel                    = 1; // x0 => width, x1 => height, x2 => depth
    Metric_OrthoMillimeter               = 2; // x0 => width, x1 => height, x2 => depth
    Metric_HexGridMillimeter             = 3; // x0 => q,     x1 => r,      x2 => s
    Metric_TrapezoDodecahedronMillimeter = 4; // TODO
}


// TagAttr is a multi-use workhorse link where all fields are optional and whose meaning is contextual.
//
// Often used to reference an asset, a Link can reference any resource, a show, project, episode, or XR beacon. 
// The tagging naming convention describes a semi-ordered list of UTF tags.  
//      As tags first appear when going from left to right in the list, they are considered "more significant" or "higher priority" than tags that appear later.
//      It is up to amp-search-dev-tag-specification to order search results based on tag filters (case sensitive, time ranges, or any UTF8 enum identifier)
//      By convention, tags are case sensitive by default, however there are many filter presets -- This is how people "type or speak search"
//      "Two tag rule" -- if you can think of two or more other tags in an order ranking, then do that instead.
message TagAttr {
    //Enable              State = 3;

    // Identifies a specific TagAttrSpec that this Link is an instance of.
    int64   Tag_0 = 2;
    fixed64 Tag_1 = 3;
    fixed64 Tag_2 = 4;

    // Identifies an attribute element series type (i.e. a data channel identifier with an implied SI format).
    int64   AttrSpec_0 = 5;
    fixed64 AttrSpec_1 = 6;
    fixed64 AttrSpec_2 = 7;
    
    int64   SI_0 = 10;
    fixed64 SI_1 = 11;
    fixed64 SI_2 = 12;
    
    string  URL         = 13; // e.g. "https://...", "amp://...", "ipfs://...", "file://...", "data:..."
    string  ContentType = 14; // e.g. "text/html", "image/png", "image/*", 
    bytes   Attachment  = 15; // inline content -- e.g. rtf text, inline thumbnails, cache fragments


    // Implies a specific interpretation or spatial encoding of the size metric values
    //      exp(LogScale) => units linear scale metric -
    //           e.g.  0.0 => 1, 1 => e^1,  3773.7337 => e^(8.23582016170069) ... )
    //double              LogScale   = 25; // natural log of the unit-to-physical scale metric (default 0.0 => 1.0)
    
    Metric              Metric = 16;
    double              Size_0 = 17;
    double              Size_1 = 18;
    double              Size_2 = 19;
    
    repeated TagAttr    SubAttrs = 24;
}




// TagHeader is a standard attribute for aa UI-visualized 24-byte time-based hashname.
// An amp.App fills in what is appropriate and leaves the rest blank.
message TagTab {

    string  Label       = 1; // utf8-text -- title, name, or primary label
    string  Caption     = 2; // utf8 text -- short synopsis, summary, slogan, or "tagline"
    string  About       = 3; // utf8 text -- amplifying information -- should be a short paragraph or less 
    
    int64   CreatedAt   = 8; // UTC << 16
    int64   ModifiedAt  = 9; // UTC << 16

    // Any URL or binary (tag) address to open / pin
    // E.g. if 'amp://...', this denotes a pinnable URL -- but could be any pinnable URL: ipfs://, https://, ...
    TagAttr Link        = 20;      
}




// TagFeed is a public channel specification / declaration / definition. 
// In general, for incoming TagFeed, a corresponding client pin op, UI tab, and UI sheet (though the sheet may often be hidden or obscured). 
//
// Most streams have 3-4 AttrFeeds:
//      amp.tag.feed.[item.ID]TagTab
//      amp.tag.feed.items.genesis.[]TagEpoch
message TagFeed {

    TagAttr             App        = 1; // optional -- specifies a particular app
    TagAttr             FeedSpec   = 2; // specifies TagFeed element schema; feed data model descriptor "amp.tag.spec.data.TagTab" -- essential for the UI to "find" its Go-side app / driver.
    TagAttr             TabUI      = 4; // tab UI to load and present to the user
    TagAttr             SheetUI    = 5; // sheet UI to load and present to the user
    
    repeated TagAttr    AttrFeeds  = 7; // keys subscribed for proper channel functioning. (e.g. "amp.tag.sync.keys.{app|channel|group|user}")
    
    repeated TagFeed    SubFeeds   = 9; // collection of attrs / channels -- potentially circular

}

/*

The U.S.C Social Experiment
 - people "vote" on what they want
 - we're making a voting os app -- invoke blockchains

*/
message TagBallotBox {

}


message TagNotes {

}


//  "amp.tag.spec.talk.spec.message"
message TagChat {
    
}

message TagSpreadsheet {
    // SI is QSR
    // 
}


message TagSurfaceGrid {
    // SI: coord
    // ElemType: tag.ID (where tag is CellID or is a hard asset ref)
}

message TagSurfaceGeo {
    // SI: geohash
    // ElemType: tag.ID (where tag is CellID or is a hard asset ref)
}


message TagPlayableMedia {

    // Elem type is PlayableMedia

}

message TagPlaylist {

}



message TagEpoch {
    
    // typically 1-4 ops that define default user and permission hive transactions, corresponding permissions tokens, and tag-wide public tokens
    // by convention, the first follows the "constitution rule" where you list things like organization or group mission and offer a purpose.TagAttr that goes into ore detail about purpose and mission.
    //
    // These essentially sequential edits to a permissions key-value store
    // TagIDs (ops)
    //      "text/amp.tag.epoch.entries.{clear|write}.{admin|commons|group}"
    //      "text/amp.tag.epoch.entries.{clear|write}.{admin|commons|group}"
    repeated TagAttr    PermissionsOps = 2;
    
    repeated TagFeed    InsertFeeds = 4;
    repeated TagFeed    RemoveFeeds = 5;

}








// CryptoKitID identifies an encryption suite that implements ski.CryptoKit
enum CryptoKitID {
    CryptoKit_Nil             = 0;
    CryptoKit_SecretBox_NaCl  = 100;
    CryptoKit_AsymMsg_NaCl    = 101;
    CryptoKit_Signing_NaCl    = 102;
    CryptoKit_Signing_ED25519 = 202;

}

message CryptoKey {
    CryptoKitID         CryptoKitID     = 1;
    bytes               KeyBytes        = 4;
}



// AuthToken is an oauth token -- see oauth2.Token
message AuthToken {
    string              AccessToken  = 1;
    string              TokenType    = 2;
    string              RefreshToken = 3;
    int64               Expiry       = 4; // Unix UTC
}

/*

message LabelAttr {
    string              Main            = 1;
    string              Subtext         = 2;
}
message SwitchAttr {
    string              Label           = 1;
    string              About           = 2;
    bool                Enabled         = 2;
}
    
message EditableTextAttr {
    string              Label           = 1;
    string              About           = 2;
    string              Content         = 3;
    int                 Flags           = 4;
}
    
    */



message TRS {

    enum VisualScaleMode {
        AutoScale  = 0;
        FixedScale = 1;
    }
    
    // X1, X2, and X3 are coordinates or values expressed in any unit.
    // A channel client can later declare how to interpret these coordinates so that a channel server and provide indexed services.
    // Shoutout to the 3 domains that reflect all theoretical completeness: alpha (finite), omega (unending), and the inaccessible cardinal(s).
    // Special thanks to Michael at Vsauce: https://www.youtube.com/watch?v=SrU9YDoXE88
    double              X1                          = 41;
    double              X2                          = 42;
    double              X3                          = 43;
    
    // Specifies how scale dynamically changes based on observer position.
    VisualScaleMode     ScaleMode                   = 50;
    
    // Scale1..3 express the scale of this placement.
    // If all three values are 0, they are all implicitly 1.
    // If Scale2 or Scale3 == 0, then it is implicitly Scale1.
    float               Scale1                      = 51;
    float               Scale2                      = 52;
    float               Scale3                      = 53;

    // Rotate1 - Rotate3 the orientation of this placement using Euler angles.
    float               Rotate1                     = 61;
    float               Rotate2                     = 62;
    float               Rotate3                     = 63;
                
}






message DataSegment {


    uint64              ByteOfs = 5;
    uint64              ByteSz = 6;
    bytes               InlineData = 7;
    string              StreamURI  = 9;
    
    int64               BlobID = 10;


}







// ErrCode expresses status and error codes.
enum ErrCode {
    ErrCode_NoErr                       = 0;

    ErrCode_UnnamedErr                  = 5000;
    ErrCode_InternalErr                 = 5001;
    ErrCode_UnsupportedOp               = 5002;
    ErrCode_Unimplemented               = 5003;
    ErrCode_Timeout                     = 5004;
    ErrCode_ShuttingDown                = 5005;
    ErrCode_NotConnected                = 5006;
    ErrCode_AuthFailed                  = 5007;
    ErrCode_LoginFailed                 = 5008;
    ErrCode_SessionExpired              = 5009;
    
    ErrCode_ReqNotFound                 = 5010;
    ErrCode_InvalidReq                  = 5020;
    ErrCode_InvalidURI                  = 5021;
    ErrCode_BadValue                    = 5022;
    ErrCode_InvalidTag                  = 5023;
    ErrCode_InvalidTagSpec              = 5024;

    ErrCode_NothingToCommit             = 5030;
    ErrCode_CommitFailed                = 5031;
    ErrCode_PlanetNotFound              = 5032;
    ErrCode_PlanetFailure               = 5033;
    ErrCode_AppNotFound                 = 5034;
    ErrCode_DefNotFound                 = 5036;
    ErrCode_MalformedTx                 = 5040;

    ErrCode_TypeNotFound                = 5050;
    ErrCode_TypeNotRegistered           = 5051;
    ErrCode_BadSchema                   = 5052;
    ErrCode_DataFailure                 = 5053;
    ErrCode_ExportErr                   = 5054;
    ErrCode_PinFailed                   = 5055;
    ErrCode_PinContextClosed            = 5056;
    ErrCode_CellNotFound                = 5058;
    ErrCode_ProviderErr                 = 5059;
    
    ErrCode_ViolatesAppendOnly          = 5100;
    ErrCode_InsufficientPermissions     = 5101;
}

enum LogLevel {
    LogLevel_Error = 0;
    LogLevel_Warn  = 2;
    LogLevel_Info  = 4;
}


// Err is a general purpose error / warning / log message.
message Err {

    // Identifies the type of error.
    ErrCode             Code  = 1;
    
    // Severity level
    LogLevel            Level = 2;
    
    // human-readable info
    string              Msg   = 4;
}